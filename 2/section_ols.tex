\subsection{原理・方法}

観測モデルを
\begin{align}
 y_i = f(\theta, x_i) + w_i
\end{align}
とする．加法雑音 $w_i$ は平均 $0$，観測ごとに独立，同一分布であり，共分散は有限と仮定する．
ここでは $f(\theta, x) = \phi(x)\theta$ としてパラメータに対して線形とし，最小二乗問題
\begin{align}
 \min_{\theta}\sum_{i=1}^{N}\lVert y_i - \phi(x_i)\theta\rVert^2
\end{align}
を解く．解は
\begin{align}
 \hat{\theta}_N
  = \Big( \sum_{i=1}^{N} \phi_i^\top \phi_i \Big)^{-1}
    \sum_{i=1}^{N} \phi_i^\top y_i,
 \qquad \phi_i := \phi(x_i).
\end{align}\cite{exp2025}.

また雑音分散が未知の場合の推定量および推定誤差共分散は
\begin{align}
 \hat{\sigma}^2
 &= \frac{1}{N-n} \sum_{i=1}^{N} \lVert y_i - \phi_i \hat{\theta}_N \rVert^2, \\
 \widehat{\mathrm{Cov}}(\hat{\theta}_N)
 &= \hat{\sigma}^2 \Big( \sum_{i=1}^{N} \phi_i^\top \phi_i \Big)^{-1}
\end{align}
で与えられる．

当てはまりの評価には決定係数
\begin{align}
 C = \frac{\sum_{i=1}^{N}\lVert \phi_i \hat{\theta}_N - \bar{y} \rVert^2}
          {\sum_{i=1}^{N}\lVert y_i - \bar{y} \rVert^2},
 \qquad
 \bar{y} = \frac{1}{N}\sum_{i=1}^{N} y_i
\end{align}
を用いる．以上は資料3.2の線形最小二乗および評価に対応する．


本実験では $\phi(x)$ として設計した特徴量から行列
\begin{align}
 X = \begin{bmatrix}
  \phi(x_1)^\top \\
  \vdots \\
  \phi(x_N)^\top
 \end{bmatrix}
\end{align}
を構成し，観測データを
\begin{align}
 y = [y_1; \dots; y_N]
\end{align}
として用いる．パラメータ推定量は
\begin{align}
 \hat{\theta} = (X^\top X)^{-1} X^\top y
\end{align}
で与えられる．

残差は
\begin{align}
 r = y - X\hat{\theta}
\end{align}
とし，雑音分散推定量は
\begin{align}
 \hat{\sigma}^2 = \frac{\lVert r \rVert^2}{N - p}
\end{align}
（$p$ は列数）とする．

パラメータ推定の誤差共分散は
\begin{align}
 \hat{\sigma}^2 (X^\top X)^{-1}
\end{align}
で与えられる．

決定係数は
\begin{align}
 C = \frac{\lVert X\hat{\theta} - \bar{y}\mathbf{1} \rVert^2}
          {\lVert y - \bar{y}\mathbf{1} \rVert^2}
\end{align}
と定義する．

以下の R 関数が上記推定を実装している．

\begin{lstlisting}[language=R]
regression_simple <- function(x, y){
    theta_hat  <- solve(t(x) %*% x) %*% t(x) %*% y
    sigma2_hat <- as.numeric(t(y - x %*% theta_hat) %*%
                             (y - x %*% theta_hat) /
                             (nrow(x) - ncol(x)))
    err_cov_mat <- sigma2_hat * solve(t(x) %*% x)
    det_coef <- sum((x %*% theta_hat - mean(y))^2) /
                sum((y - mean(y))^2)
    list(theta_hat=theta_hat, err_cov_mat=err_cov_mat,
         sigma2_hat=sigma2_hat, det_coef=det_coef)
}
\end{lstlisting}


\subsection{課題1（重回帰）}

\paragraph{モデル}
$y_i = x_i^\top \theta + w_i \ (i=1,\dots,N)$．$x_i\in\mathbb{R}^2$．$w_i$ は独立，同分散 $\sigma^2$，平均0．
$X=[x_1^\top;\dots;x_N^\top]\in\mathbb{R}^{N\times2}$，$y=[y_1;\dots,y_N]\in\mathbb{R}^N$．

\paragraph{推定量}
最小二乗推定量
\[
\hat\theta_N=(X^\top X)^{-1}X^\top y .
\]
残差 $r=y-X\hat\theta_N$ により
\[
\hat\sigma^2=\frac{\|r\|_2^2}{N-p},\quad p=2, \qquad
\widehat{\mathrm{Cov}}(\hat\theta_N)=\hat\sigma^2\,(X^\top X)^{-1}.
\]
決定係数
\[
R^2=\frac{\|X\hat\theta_N-\bar y\mathbf{1}\|_2^2}{\|y-\bar y\mathbf{1}\|_2^2},\quad
\bar y=\frac1N\sum_{i=1}^N y_i .
\]

\paragraph{実装}
データから設計行列 $X$ と観測ベクトル $y$ を構成し，$\hat\theta = (X^\top X)^{-1} X^\top y$ により推定量を計算する．
残差 $r = y - X\hat\theta$ から雑音分散推定量 $\hat\sigma^2 = \|r\|^2/(N-p)$ を求め，
推定誤差共分散 $\hat\sigma^2 (X^\top X)^{-1}$ および決定係数 $R^2$ を算出する関数を実装した．
以下がRによる実装例である。
\begin{lstlisting}[language=R]
# データの読み込み
data <- read.csv("datas/mmse_kadai1.csv", header=FALSE,
                 col.names = c("x1","x2","y"))
x <- as.matrix(data[,c("x1","x2")])
y <- as.matrix(data[,"y"])

# サンプルサイズ n で推定を実行する関数
exp1 <- function (x, y, n){
    x_n <- x[1:n,]
    y_n <- y[1:n,]
    result <- regression_simple(x_n, y_n)
    return(list(theta_hat = result$theta_hat, 
                err_cov_mat = result$err_cov_mat, 
                det_coef = result$det_coef))
}

N_max <- nrow(x)
print(exp1(x, y, N_max)$theta_hat)
print(exp1(x, y, N_max)$err_cov_mat)
print(exp1(x, y, N_max)$det_coef)

# 収束の可視化
plot_exp1 <- function(x, y){
    ns <- c(2,4,8,16,32,64,128,256,512,1024,2048,4096,8192)
    theta_hats <- matrix(0, nrow=length(ns), ncol=ncol(x))
    for (i in 1:length(ns)){
        result <- exp1(x, y, ns[i])
        theta_hats[i, ] <- as.vector(result$theta_hat)  
    }
    png("graphs/task1.png")
    matplot(ns, theta_hats, type="b", log="x", xlab="n", ylab="theta_hat",
            main="Convergence of theta_hat")
    dev.off()
}
plot_exp1(x, y)
\end{lstlisting}

\paragraph{収束確認}
$N\in\{2,4,8,\dots,2^{13}=8192\}$ で $\hat\theta_N$ を計算し，$N$ を横軸とする片対数図で各成分を同一図に描く．

\paragraph{結果（全データ $N=10000$）}
\[
\hat\theta_{N}=
\begin{bmatrix}
1.507\\
1.998
\end{bmatrix},\qquad
\widehat{\mathrm{Cov}}(\hat\theta_{N})=
\begin{bmatrix}
9.867 & -0.04081\\
-0.04081 & 10.05
\end{bmatrix}\times10^{-5}.
\]
決定係数
R^2=0.8630 .
\[
\]

\begin{figure}[H]
  \centering
  \includegraphics[width=0.75\linewidth]{graphs/task1.png}
  \caption{$\hat\theta_N$ の収束（横軸 $N=2,4,\dots,8192$ の片対数）}
  \label{fig:task1-conv}
\end{figure}

\paragraph {考察}
図\ref{fig:task1-conv}から，$\hat\theta_N$ は $N$ を増やすにつれて収束していることが確認できた．
また、共分散行列の非対角成分が対角成分に比べて非常に小さいことから，確かに各成分の推定誤差が独立であることも示唆された。

\subsection{課題2（多項式回帰）}

\paragraph{モデル}
$y_i=\varphi(x_i)\theta+w_i,\quad \varphi(x)=[\,1\ x\ x^2\ x^3\,],\ i=1,\dots,N.$
雑音 $w_i$ は独立，同分散 $\sigma^2$，平均0．分散9の正規分布．
$X=[\varphi(x_1);\dots;\varphi(x_N)]\in\mathbb{R}^{N\times4}$．

\paragraph{推定量}
推定量・共分散・決定係数は課題1と同じ形式（$p=4$）で計算する．

\paragraph{実装}
入力 $x_i$ から特徴ベクトル $\varphi(x_i) = [1\ x_i\ x_i^2\ x_i^3]$ を構成し，設計行列 $X$ を作成する．
課題1と同様の関数を用いてパラメータ推定量，誤差共分散，決定係数を算出する．
$N\in\{4,8,16,\dots,8192\}$ の各点で推定量を計算し，片対数プロットで収束の様子を可視化した．

\paragraph{収束確認}
$N\in\{4,8,16,\dots,8192\}$ で $\hat\theta_N$ を計算し，$N$ を横軸とする片対数図で各成分を同一図に描画する．

\paragraph{結果（全データ $N=10000$）}
\[
\hat\theta_N=\begin{bmatrix}
-0.5090\\
\ \ 1.976\\
\ \ 0.1977\\
-0.09867
\end{bmatrix},\qquad
\widehat{\mathrm{Cov}}(\hat\theta_N)=\begin{bmatrix}
2.023 & -0.01186 & -0.1348 & 0.0003971\\
-0.01186 & 6.753 & -0.001899 & -37.95\\
-0.1348 & -0.001899 & 16.04 & 0.06352\\
0.0003971 & -37.95 & 0.06352 & 2.529
\end{bmatrix}\times10^{-3}.
\]


決定係数：
\[
R^2=0.4619 .
\]

\begin{figure}[H]
  \centering
  \includegraphics[width=0.75\linewidth]{graphs/task2.png}
  \caption{$\hat\theta_N$ の収束（横軸 $N=4,8,\dots,8192$ の片対数）}
  \label{fig:task2-conv}
\end{figure}

\paragraph {考察}
図\ref{fig:task2-conv}から，課題1と同様に，$\hat\theta_N$ は $N$ を増やすにつれて収束し、対角成分に比べて非対角成分が小さいかったものの、課題1よりも収束が遅く、非対角成分の割合がやや大きいことが確認できた。なにより，モデルの精度を表す決定係数 $R^2$ が課題1に比べて大幅に低下しており，モデルの当てはまりが悪化していることが分かる。
これについて、課題2では雑音分散が9と大きく設定されており、これは元データのｘに対する影響が大きいため、モデルの当てはまりが悪化したと考えられる。特に定数項と1次項の収束が遅いことから、これらの成分が雑音よりも十分に大きくないのでその影響を受けやすいことが示唆される。


\subsection{課題3（分散の観測誤差：Cauchy）}

\paragraph{モデルと注意}
$y_i=x_i^\top\theta+w_i\ (i=1,\dots,N)$，$x_i\in\mathbb{R}^2$．
観測誤差 $w_i\sim \mathrm{Cauchy}(0,1)$ 独立同分布．

\paragraph{推定量}
推定量・共分散・決定係数は課題1と同じ形式（$p=2$）で計算する．

\paragraph{実装}
課題1と同じ最小二乗推定の枠組みを用いて，$N\in\{2,4,\dots,8192\}$ の各サンプルサイズで推定量を計算した．


\paragraph{結果（全データ $N=10000$）}
\[
\hat\theta_N=
\begin{bmatrix}
2.373\\
1.537
\end{bmatrix},\qquad
\widehat{\mathrm{Cov}}(\hat\theta_N)=
\begin{bmatrix}
9.235 & -0.003642\\
-0.003642 & 9.264
\end{bmatrix}.
\]
参考：対角の平方根は
$\mathrm{SE}(\hat\theta_1)\approx 3.039,\ 
 \mathrm{SE}(\hat\theta_2)\approx 3.044$．
決定係数（参考値）は
\[
R^2=0.0002841 .
\]

\begin{figure}[H]
  \centering
  \includegraphics[width=0.75\linewidth]{graphs/task3.png}
  \caption{$\hat\theta_N$ の非収束例（横軸 $N=2,4,\dots,8192$ の片対数）}
  \label{fig:task3-conv}
\end{figure}

\paragraph{考察}
図\ref{fig:task3-conv}より，資料にあるように、Cauchy 誤差では外れ値の影響が支配的で，$\hat\theta_N$ は $N$ を増やしても収束せず、決定係数もほぼ0であることが確認できた。


\subsection{課題4（入力域の制約と設計）}

\paragraph{設定}
課題2と同じ $\varphi(x)=[\,1\ x\ x^2\ x^3\,]$, 真の $\theta$, 観測誤差 $w_i\sim\mathcal{N}(0,9)$ とする．
ただし入力は $x_i\in[0,1]$, $i=1,\dots,10000$．
$X=[\varphi(x_1);\dots;\varphi(x_N)]\in\mathbb{R}^{N\times4}$, $y=[y_1;\dots;y_N]$．

\paragraph{推定量}
推定量・共分散・決定係数は課題1と同じ形式（$p=4$）で計算する．

\paragraph{実装}
課題2と同様に $\varphi(x)=[1\ x\ x^2\ x^3]$ の特徴ベクトルを用いて設計行列を構成し，
全データ $N=10000$ に対して最小二乗推定を行った．

\paragraph{結果（$N=10000$）}
\[
\hat\theta_{(4)}=
\begin{bmatrix}
-0.5777\\
\ \ 2.097\\
-0.3950\\
\ \ 0.5491
\end{bmatrix},\quad
\widehat{\mathrm{Cov}}(\hat\theta_{(4)})=\begin{bmatrix}
0.1532 & -1.149 & \ \ 2.296 & -1.339\\
-1.149 & 11.46 & -25.75 & 16.01\\
\ \ 2.296 & -25.75 & 61.72 & -39.97\\
-1.339 & 16.01 & -39.97 & 26.62
\end{bmatrix},\quad
R^2=0.04084.
\]


\paragraph{課題2.1との比較（$N=10000$）}
課題2.1の推定結果：
\[
\hat\theta_{(2.1)}=
\begin{bmatrix}
-0.5090\\
\ \ 1.976\\
\ \ 0.1977\\
-0.09867
\end{bmatrix},\quad
R^2=0.4619.
\]



\paragraph{考察}
精度が大幅に低下していることが確認できた。これは、入力 $x$ が $[0,1]$ に制約されることで、特徴量 $\varphi(x)$ の値域が狭まり、設計行列 $X$ の列間の相関が高くなったことが原因と考えられる。また,$x$ が $[0,1]$に制約されることは、高次項も小さな値に限定されることを意味し、雑音の分散が9であることを考慮すると、モデルの当てはまりがさらに悪化したと考えられる。
入力設計の工夫としては、
\begin{itemize}\setlength{\itemsep}{0pt}
\item xの分散を十分に大きくすることで、雑音の影響が相対的に小さくなるようにする。
\item xの値を[0,1]区間から大きく離すことで、特徴量同士の相関を低減させる。
\end{itemize}
が挙げられる。