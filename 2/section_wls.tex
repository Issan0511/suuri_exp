\subsection{原理と方法}

\paragraph{原理}
各観測 $i=1,\dots,N$ で $y_i\in\mathbb{R}^m$, $X_i\in\mathbb{R}^{m\times p}$ とし
\[
y_i = X_i\theta + w_i,\qquad \mathbb{E}[w_i]=0,\ \mathrm{Cov}(w_i)=V\ (\text{既知}), 
\]
を仮定する。$Q:=V^{-1}$ とおく。WLS は重み付き残差平方和
\[
J(\theta)=\sum_{i=1}^N (y_i-X_i\theta)^\top Q\,(y_i-X_i\theta)
\]
を最小化する推定で，正規方程式は
\[
S\hat\theta=b,\qquad 
S:=\sum_{i=1}^N X_i^\top QX_i,\quad 
b:=\sum_{i=1}^N X_i^\top Qy_i.
\]
したがって
\[
\hat\theta=(\sum_{i=1}^N X_i^\top QX_i)^{-1}\Big(\sum_{i=1}^N X_i^\top Qy_i\Big).
\]
$V$ が既知のとき
\[
\mathrm{Cov}(\hat\theta)=S^{-1}.
\]
$V=\sigma^2\Sigma$ のようにスケール未知なら
\[
\hat\sigma^2=\frac{\sum_{i=1}^N r_i^\top \Sigma^{-1} r_i}{Nm-p},\quad r_i:=y_i-X_i\hat\theta,\qquad
\widehat{\mathrm{Cov}}(\hat\theta)=\hat\sigma^2\,(\sum X_i^\top \Sigma^{-1}X_i)^{-1}.
\]

\paragraph{方法}
(1) 各 $i$ の設計行列 $X_i$ と観測 $y_i$ を用意（$X_i$ は $m\times p$）。  
(2) $Q=V^{-1}$ を決めて $S=\sum X_i^\top QX_i,\ b=\sum X_i^\top Qy_i$ を計算。  
(3) $\hat\theta=S^{-1}b$。  

\paragraph{実装}
R による実装例を以下に示す。
\begin{lstlisting}
regression_multiple <- function(x, y, V = NULL, Q = NULL){
    # y: n×1行列（またはベクトル）
    if (is.null(ncol(y))) {
        y <- as.matrix(y, ncol = 1)
    }
    if (length(dim(x)) != 3) {
        stop("x must be a 3-dimensional array")
    }
    n <- dim(x)[3]
    m <- ncol(y)
    p <- dim(x)[1] # 特徴量数
    S <- matrix(0, p, p)
    b <- matrix(0, p, 1)
    T <- matrix(0, p, p)
    if (is.null(V)) {
        V <- diag(m)
    }
    if (is.null(Q)) {
        Q <- solve(V)
    }
    # m=1（スカラー出力）の場合はQ,Vをスカラー化
    if (m == 1) {
        Q <- as.numeric(Q)
        V <- as.numeric(V)
        for (i in 1:n) {
            xi <- as.matrix(x[,,i]) # (p,1)
            S <- S + xi %*% t(xi) * Q
            b <- b + xi * Q * y[i, 1]
            T <- T + xi %*% t(xi) * V
        }
    } else {
        for (i in 1:n) {
            xi <- as.matrix(x[,,i])
            yi <- matrix(y[i, ], nrow = m, ncol = 1)
            S <- S + t(xi) %*% Q %*% xi
            b <- b + t(xi) %*% Q %*% yi
            T <- T + t(xi) %*% V %*% xi
        }
    }
    theta_hat <- solve(S) %*% b
    err_cov_mat <- solve(S) %*% T %*% solve(S)
    return(list(theta_hat = theta_hat, err_cov_mat = err_cov_mat, S = S, b = b, T = T))
}
\end{lstlisting}

